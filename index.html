<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>ContabilitÃ  Cloud ðŸŒ»</title>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5836/5836611.png">

<meta name="apple-mobile-web-app-title" content="ContabilitÃ ">

<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAHQo-J8K54vXUhvGpYQcIG3srUI8lYR5c",
            authDomain: "contabilita-bf865.firebaseapp.com",
            projectId: "contabilita-bf865",
            storageBucket: "contabilita-bf865.firebasestorage.app",
            messagingSenderId: "1074422505478",
            appId: "1:1074422505478:web:c2b99419a10e1d9f5f6387",
            measurementId: "G-T6X8J09ZZ7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const transazioniRef = collection(db, "transazioni");

        window.registraInCloud = async (dati) => {
            await addDoc(transazioniRef, { ...dati, timestamp: Date.now() });
        };

        window.eliminaDalCloud = async (id) => {
            if(confirm("Eliminare definitivamente questa operazione?")) await deleteDoc(doc(db, "transazioni", id));
        };

        onSnapshot(query(transazioniRef, orderBy("data", "desc")), (snapshot) => {
            const dati = [];
            snapshot.forEach(doc => dati.push({ id: doc.id, ...doc.data() }));
            window.mostraDati(dati);
        });
    </script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: url('https://upload.wikimedia.org/wikipedia/commons/4/46/Vincent_Willem_van_Gogh_127.jpg') fixed center/cover; }
        .container { max-width: 950px; margin: auto; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        
        .bilancio-box { text-align: center; font-size: 2.5em; font-weight: bold; padding: 20px; background: white; border-radius: 20px; border: 2px solid #f1c40f; margin-bottom: 25px; }
        .moduli-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .modulo { padding: 20px; border-radius: 20px; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 12px; }
        .modulo-entrate { border-top: 6px solid #27ae60; }
        .modulo-uscite { border-top: 6px solid #e74c3c; }

        .form-row { display: flex; gap: 10px; }
        input, select { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; }
        
        .sezione-gestione { background: #f8faff; border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #e0e6ed; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: flex-end; }
        
        .btn { cursor: pointer; font-weight: bold; border: none; border-radius: 8px; padding: 10px 15px; transition: 0.2s; display: flex; align-items: center; gap: 5px; font-size: 14px; }
        
        /* STILE LISTA E ICONA CLIP */
        .sezione-lista { background: white; border-radius: 20px; padding: 20px; }
        li { padding: 15px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        .info-movimento { display: flex; align-items: center; gap: 15px; flex: 1; }
        
        .clip-icon { 
            font-size: 1.4em; 
            cursor: pointer; 
            color: #7f8c8d; 
            padding: 8px;
            border-radius: 50%;
            background: #f9f9f9;
            transition: 0.2s;
            line-height: 1;
        }
        .clip-icon:hover { 
            background: #ecf0f1; 
            color: #2980b9; 
            transform: scale(1.1);
        }

        .val-pos { color: #27ae60; font-weight: bold; }
        .val-neg { color: #e74c3c; font-weight: bold; }
        
        .btn-delete { color: #ccc; background: none; border: none; font-size: 1.2em; cursor: pointer; margin-left: 15px; }
        .btn-delete:hover { color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; margin-bottom: 15px; color: #5d4037;">ðŸŒ» ContabilitÃ  Cloud ðŸŽ¨</h2>
    <div class="bilancio-box" id="saldo-totale">â‚¬ 0.00</div>

    <div class="moduli-grid">
        <div class="modulo modulo-entrate">
            <h3>âœ¨ + Entrata</h3>
            <form id="form-in" style="display:contents;">
                <div class="form-row"><input type="text" id="desc-in" placeholder="Sorgente" required><input type="number" step="0.01" id="val-in" placeholder="Importo â‚¬" required></div>
                <div class="form-row"><input type="date" id="data-in" required><select id="cat-in"></select></div>
                <input type="url" id="link-in" placeholder="ðŸ”— Link Drive allegato (opzionale)" style="width:100%;">
                <button type="submit" style="background:#27ae60; color:white;" class="btn">Salva âœ¨</button>
            </form>
        </div>
        <div class="modulo modulo-uscite">
            <h3>ðŸ¥€ - Uscita</h3>
            <form id="form-out" style="display:contents;">
                <div class="form-row"><input type="text" id="desc-out" placeholder="Spesa" required><input type="number" step="0.01" id="val-out" placeholder="Importo â‚¬" required></div>
                <div class="form-row"><input type="date" id="data-out" required><select id="cat-out"></select></div>
                <div style="height:42px;"></div>
                <button type="submit" style="background:#e74c3c; color:white;" class="btn">Annota ðŸ¥€</button>
            </form>
        </div>
    </div>

    <div class="sezione-gestione">
        <div class="form-row">
            <input type="text" id="search" placeholder="ðŸ” Cerca per descrizione o categoria..." onkeyup="filtraLocalmente()">
            <select id="filtro-anno" onchange="filtraLocalmente()" style="max-width:150px;"></select>
        </div>
        <div class="toolbar">
            <button class="btn" style="background:#2c3e50; color:white;" onclick="esportaPDF()">Stampa PDF ðŸ“„</button>
            <button class="btn" style="background:white; border:1px solid #ddd;" onclick="esportaCSV()">Salva CSV ðŸ’¾</button>
        </div>
    </div>

    <div class="sezione-lista"><ul id="lista-voci"></ul></div>
</div>

<script>
    let datiGlobali = [];
    const categorie = ["Stipendio", "Toeletta", "Parrucchiere", "Estetista", "Spesa Coop", "Spesa Conad", "Spesa Varia", "Spesa Trasferta", "Generale"];

    function inizializza() {
        const selects = [document.getElementById('cat-in'), document.getElementById('cat-out')];
        selects.forEach(s => categorie.sort().forEach(c => s.add(new Option(c, c))));
        const fAnni = document.getElementById('filtro-anno');
        fAnni.add(new Option("Tutti gli anni", "Tutti"));
        for(let i=2026; i>=2024; i--) fAnni.add(new Option(i, i));
        document.getElementById('data-in').valueAsDate = document.getElementById('data-out').valueAsDate = new Date();
    }

    window.mostraDati = (dati) => { datiGlobali = dati; filtraLocalmente(); };

    function filtraLocalmente() {
        const s = document.getElementById('search').value.toLowerCase();
        const a = document.getElementById('filtro-anno').value;
        const lista = document.getElementById('lista-voci');
        lista.innerHTML = '';
        let saldo = 0;

        datiGlobali.filter(t => (a === "Tutti" || t.data.startsWith(a)) && (t.descrizione.toLowerCase().includes(s) || t.categoria.toLowerCase().includes(s)))
        .forEach(t => {
            saldo += t.importo;
            
            // Icona Clip se presente il link
            const clipHtml = t.link ? `<span class="clip-icon" onclick="window.open('${t.link}', '_blank')" title="Apri allegato Drive">ðŸ“Ž</span>` : `<div style="width:40px;"></div>`;
            
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="info-movimento">
                    ${clipHtml}
                    <div>
                        <small style="color:#888;">${t.data}</small> | <b>${t.categoria}</b><br>
                        <span>${t.descrizione}</span>
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <span class="${t.importo >= 0 ? 'val-pos' : 'val-neg'}">â‚¬ ${Math.abs(t.importo).toFixed(2)}</span>
                    <button class="btn-delete" onclick="window.eliminaDalCloud('${t.id}')">âœ•</button>
                </div>`;
            lista.appendChild(li);
        });
        document.getElementById('saldo-totale').innerText = `â‚¬ ${saldo.toFixed(2)}`;
    }

    function esportaPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Resoconto ContabilitÃ  ðŸŒ»", 14, 15);
        const rows = datiGlobali.map(t => [t.data, t.categoria, t.descrizione, t.importo.toFixed(2) + " â‚¬"]);
        doc.autoTable({ head: [['Data', 'Categoria', 'Descrizione', 'Importo']], body: rows, startY: 20 });
        doc.save("Contabilita_Cloud.pdf");
    }

    function esportaCSV() {
        let csv = "Data,Categoria,Descrizione,Importo\n";
        datiGlobali.forEach(t => csv += `${t.data},${t.categoria},${t.descrizione},${t.importo}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'contabilita.csv'; a.click();
    }

    document.getElementById('form-in').onsubmit = async (e) => {
        e.preventDefault();
        await window.registraInCloud({ 
            descrizione: document.getElementById('desc-in').value, 
            importo: parseFloat(document.getElementById('val-in').value), 
            data: document.getElementById('data-in').value, 
            categoria: document.getElementById('cat-in').value, 
            link: document.getElementById('link-in').value || '', 
            tipo: 'IN' 
        });
        e.target.reset(); document.getElementById('data-in').valueAsDate = new Date();
    };

    document.getElementById('form-out').onsubmit = async (e) => {
        e.preventDefault();
        await window.registraInCloud({ 
            descrizione: document.getElementById('desc-out').value, 
            importo: -Math.abs(parseFloat(document.getElementById('val-out').value)), 
            data: document.getElementById('data-out').value, 
            categoria: document.getElementById('cat-out').value, 
            link: '', 
            tipo: 'OUT' 
        });
        e.target.reset(); document.getElementById('data-out').valueAsDate = new Date();
    };

    inizializza();
</script>
</body>
</html>