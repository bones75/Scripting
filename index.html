<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Gestione Cloud PC - Fixed ðŸŒ»</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAHQo-J8K54vXUhvGpYQcIG3srUI8lYR5c",
            authDomain: "contabilita-bf865.firebaseapp.com",
            projectId: "contabilita-bf865",
            storageBucket: "contabilita-bf865.firebasestorage.app",
            messagingSenderId: "1074422505478",
            appId: "1:1074422505478:web:c2b99419a10e1d9f5f6387",
            measurementId: "G-T6X8J09ZZ7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const transazioniRef = collection(db, "transazioni");

        window.registraInCloud = async (dati) => {
            await addDoc(transazioniRef, { ...dati, timestamp: Date.now() });
        };

        window.eliminaDalCloud = async (id) => {
            if(confirm("Eliminare?")) await deleteDoc(doc(db, "transazioni", id));
        };

        onSnapshot(query(transazioniRef, orderBy("data", "desc")), (snapshot) => {
            const dati = [];
            snapshot.forEach(doc => dati.push({ id: doc.id, ...doc.data() }));
            window.mostraDati(dati);
        });
    </script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f0f2f5 url('https://upload.wikimedia.org/wikipedia/commons/4/46/Vincent_Willem_van_Gogh_127.jpg') fixed center/cover;
            padding: 20px;
        }
        
        /* Contenitore principale centrato e contenuto */
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.97); 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        /* Header con Titolo e Totale centrati */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            width: 100%;
        }

        .bilancio-box { 
            font-size: 2.2em; 
            font-weight: 800; 
            padding: 10px 25px; 
            border: 3px solid #f1c40f; 
            border-radius: 15px;
            background: white;
        }

        /* Griglia dei moduli - Impedisce la fuoriuscita */
        .grid-moduli { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 30px;
            width: 100%;
        }
        
        .modulo { 
            flex: 1; /* Divide lo spazio equamente */
            padding: 20px; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-top: 5px solid transparent;
        }
        .modulo-in { border-top-color: #27ae60; }
        .modulo-out { border-top-color: #e74c3c; }

        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { 
            width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px; font-size: 14px; 
        }
        
        .btn-main { 
            width: 100%; padding: 12px; border: none; border-radius: 8px; 
            color: white; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        /* Tabella Rigorosa */
        .sezione-lista { width: 100%; background: white; border-radius: 15px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #f1f1f1; color: #999; font-size: 0.8em; }
        td { padding: 12px; border-bottom: 1px solid #f9f9f9; word-wrap: break-word; }
        
        .val-pos { color: #27ae60; font-weight: bold; }
        .val-neg { color: #e74c3c; font-weight: bold; }

        .toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-tool { padding: 8px 15px; border-radius: 8px; border: none; color: white; cursor: pointer; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ðŸŒ» Gestione Cloud</h1>
        <div class="bilancio-box" id="saldo-totale">â‚¬ 0.00</div>
    </div>

    <div class="grid-moduli">
        <div class="modulo modulo-in">
            <h3 style="color:#27ae60; margin-bottom:15px;">âœ¨ Entrata</h3>
            <form id="form-in">
                <div class="form-row">
                    <input type="text" id="desc-in" placeholder="Sorgente" required>
                    <input type="number" step="0.01" id="val-in" placeholder="â‚¬" required>
                </div>
                <select id="cat-in" style="margin-bottom:10px;"></select>
                <button type="submit" class="btn-main" style="background:#27ae60;">Salva Entrata</button>
            </form>
        </div>

        <div class="modulo modulo-out">
            <h3 style="color:#e74c3c; margin-bottom:15px;">ðŸ¥€ Uscita</h3>
            <form id="form-out">
                <div class="form-row">
                    <input type="text" id="desc-out" placeholder="Spesa" required>
                    <input type="number" step="0.01" id="val-out" placeholder="â‚¬" required>
                </div>
                <select id="cat-out" style="margin-bottom:10px;"></select>
                <button type="submit" class="btn-main" style="background:#e74c3c;">Annota Spesa</button>
            </form>
        </div>
    </div>

    <div class="sezione-lista">
        <table>
            <thead>
                <tr>
                    <th style="width:15%;">Data</th>
                    <th style="width:20%;">Categoria</th>
                    <th>Descrizione</th>
                    <th style="width:15%; text-align:right;">Importo</th>
                    <th style="width:50px;"></th>
                </tr>
            </thead>
            <tbody id="tabella-body"></tbody>
        </table>

        <div class="toolbar">
            <button class="btn-tool" style="background:#34495e;" onclick="esportaPDF()">Esporta PDF</button>
            <button class="btn-tool" style="background:#8e44ad;" onclick="document.getElementById('input-file').click()">Importa Access</button>
            <input type="file" id="input-file" style="display:none" accept=".xlsx, .csv" onchange="importaExcel(event)">
        </div>
    </div>
</div>

<script>
    let datiGlobali = [];
    const categorie = ["Stipendio", "Toeletta", "Spesa", "Affitto", "Bollette", "Generale"];

    function inizializza() {
        const selects = [document.getElementById('cat-in'), document.getElementById('cat-out')];
        selects.forEach(s => categorie.forEach(c => s.add(new Option(c, c))));
    }

    window.mostraDati = (dati) => { datiGlobali = dati; render(); };

    function render() {
        const body = document.getElementById('tabella-body');
        body.innerHTML = '';
        let saldo = 0;

        datiGlobali.forEach(t => {
            saldo += t.importo;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${t.data}</td>
                <td><span style="font-size:12px; background:#f4f4f4; padding:2px 6px; border-radius:4px;">${t.categoria}</span></td>
                <td>${t.descrizione}</td>
                <td style="text-align:right;" class="${t.importo >= 0 ? 'val-pos' : 'val-neg'}">${t.importo.toFixed(2)}â‚¬</td>
                <td><button onclick="window.eliminaDalCloud('${t.id}')" style="border:none; background:none; color:#ccc; cursor:pointer;">âœ•</button></td>
            `;
            body.appendChild(tr);
        });
        document.getElementById('saldo-totale').innerText = `â‚¬ ${saldo.toFixed(2)}`;
    }

    document.getElementById('form-in').onsubmit = async (e) => {
        e.preventDefault();
        await window.registraInCloud({ descrizione: document.getElementById('desc-in').value, importo: parseFloat(document.getElementById('val-in').value), data: new Date().toISOString().split('T')[0], categoria: document.getElementById('cat-in').value });
        e.target.reset();
    };

    document.getElementById('form-out').onsubmit = async (e) => {
        e.preventDefault();
        await window.registraInCloud({ descrizione: document.getElementById('desc-out').value, importo: -Math.abs(parseFloat(document.getElementById('val-out').value)), data: new Date().toISOString().split('T')[0], categoria: document.getElementById('cat-out').value });
        e.target.reset();
    };

    inizializza();
</script>
</body>
</html>
